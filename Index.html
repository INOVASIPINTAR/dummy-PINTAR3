<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PINTAR ‚Äî Pelayanan Informasi Tata Ruang (Improved)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#app{height:100%;margin:0}
    #map{height:100vh}
    .place{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);}
    .small{font-size:12px;color:#94a3b8}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div id="app" class="flex h-screen">
  <!-- SIDEBAR -->
  <aside class="w-80 bg-slate-900 text-white p-4 flex flex-col gap-4">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 rounded-lg bg-blue-600 flex items-center justify-center font-bold">P</div>
      <div>
        <div class="text-lg font-semibold">PINTAR</div>
        <div class="text-xs text-slate-300">Pelayanan Informasi Tata Ruang</div>
      </div>
    </div>

    <div class="flex gap-2">
      <input id="coordInput" class="flex-1 rounded-md px-3 py-2 bg-slate-800 placeholder-slate-400" placeholder="Masukkan koordinat: lat, lng" />
      <button id="searchBtn" class="px-3 py-2 rounded-md bg-blue-600">Cari</button>
      <button id="locBtn" class="px-3 py-2 rounded-md bg-slate-700" title="Lokasi Saya">üìç</button>
    </div>

    <div class="bg-slate-800 p-3 rounded">
      <div class="text-sm font-medium mb-2">Layer</div>
      <div class="flex items-center justify-between text-sm"><div>Base map</div><div id="baseSelect" class="text-xs text-slate-300">Street</div></div>
      <div class="mt-2 flex items-center justify-between"><div>Pola Ruang</div><input id="toggleZonasi" type="checkbox" checked /></div>
      <div class="mt-2 flex items-center justify-between"><div>Penggunaan Lahan</div><input id="toggleUse" type="checkbox" checked /></div>
      <div class="mt-2 flex items-center justify-between"><div>Dummy Data</div><input id="toggleDummy" type="checkbox" checked /></div>
    </div>

    <div class="flex-1 overflow-auto">
      <div class="text-sm font-medium mb-2">Daftar Fitur (klik untuk zoom)</div>
      <div id="placeList" class="space-y-2"></div>
    </div>

    <div class="text-xs text-slate-400">
      Petunjuk singkat: untuk menampilkan data QGIS, buka file HTML ini dan ganti variabel <code>zonasiGeoJSON</code> dan <code>penggunaanGeoJSON</code> di bagian &lt;script&gt; dengan isi file GeoJSON hasil export (EPSG:4326). Untuk testing lokal gunakan <code>python -m http.server</code> dan buka <code>http://localhost:8000</code>.
    </div>
  </aside>

  <!-- MAP -->
  <main class="flex-1 relative">
    <div id="map"></div>

    <div id="featureCard" class="absolute left-1/2 -translate-x-1/2 top-6 bg-white rounded-lg shadow-lg p-4 w-96 hidden">
      <h3 id="fTitle" class="font-semibold text-slate-800">Judul</h3>
      <div class="mt-1 text-sm text-slate-600" id="fDesc">Deskripsi</div>
      <div class="mt-3 flex justify-end gap-2"><button id="closeCard" class="px-3 py-1 text-sm bg-slate-200 rounded">Tutup</button></div>
    </div>
  </main>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// =========================
// PINTAR WebGIS ‚Äî Improved
// =========================
// Notes: 
//  - To integrate your QGIS GeoJSON: replace zonasiGeoJSON & penggunaanGeoJSON objects below.
//  - For Google Satellite tiles: USE_GOOGLE_SAT = true (check licensing). Esri World Imagery used by default.
//  - Search & Location add markers to transientLayer (so they can be cleared).

// ----- SAMPLE / DUMMY GEOJSON (replace these with your exported files) -----
const zonasiGeoJSON = {
  "type":"FeatureCollection","features":[
    {"type":"Feature","properties":{"name":"Kawasan Permukiman","kode":"Z-1","description":"Zona permukiman skala rendah","area":"12 ha"},"geometry":{"type":"Polygon","coordinates":[[[106.816,-6.200],[106.822,-6.205],[106.828,-6.200],[106.816,-6.200]]] }},
    {"type":"Feature","properties":{"name":"Kawasan Hijau","kode":"Z-2","description":"Ruang terbuka hijau","area":"8 ha"},"geometry":{"type":"Polygon","coordinates":[[[106.806,-6.195],[106.812,-6.199],[106.818,-6.193],[106.806,-6.195]]] }}
  ]
};

const penggunaanGeoJSON = {
  "type":"FeatureCollection","features":[
    {"type":"Feature","properties":{"name":"Pertanian","use":"Agriculture","area":"6 ha"},"geometry":{"type":"Polygon","coordinates":[[[106.824,-6.208],[106.829,-6.213],[106.835,-6.208],[106.824,-6.208]]] }},
    {"type":"Feature","properties":{"name":"Perdagangan","use":"Commercial","area":"2 ha"},"geometry":{"type":"Polygon","coordinates":[[[106.818,-6.188],[106.824,-6.192],[106.829,-6.187],[106.818,-6.188]]] }}
  ]
};

const dummyGeoJSON = {
  "type":"FeatureCollection",
  "features":[
    {"type":"Feature","properties":{"name":"Dummy Point","type":"point","description":"Contoh fitur titik"},"geometry":{"type":"Point","coordinates":[106.820,-6.202]}},
    {"type":"Feature","properties":{"name":"Dummy Polygon","type":"polygon","description":"Contoh fitur poligon"},"geometry":{"type":"Polygon","coordinates":[[[106.812,-6.198],[106.816,-6.200],[106.818,-6.196],[106.812,-6.198]]]}}
  ]
};

// ----- MAP INIT -----
const map = L.map('map', { zoomControl:false }).setView([-6.2, 106.816], 13);
L.control.zoom({ position:'bottomright' }).addTo(map);

// ----- BASEMAPS -----
const USE_GOOGLE_SAT = false; // change to true if you understand Google terms
const googleSatTile = L.tileLayer('https://mt0.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom:20, attribution: 'Imagery \u00a9 Google' });
const esriSatTile = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri WorldImagery' });
const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' });
const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap & CartoDB' });

streetLayer.addTo(map);

const baseMaps = { 'Street': streetLayer, 'Basemap (Light)': lightLayer, 'Satellite (Esri)': esriSatTile };
if(USE_GOOGLE_SAT) baseMaps['Google Satellite'] = googleSatTile;

// ----- LAYER STYLES & CREATION -----
function styleZonasi(){ return { color:'#1e90ff', weight:1, fillColor:'#1e90ff', fillOpacity:0.15 }; }
function stylePenggunaan(feature){ const use = feature.properties && (feature.properties.use || feature.properties.tipe) || 'other'; const colorMap = { Agriculture:'#16a34a', Commercial:'#ef4444', other:'#f59e0b' }; return { color: colorMap[use]||colorMap.other, weight:1, fillOpacity:0.15 }; }

const zonasiLayer = L.geoJSON(zonasiGeoJSON, { style: styleZonasi, onEachFeature: onEachFeature }).addTo(map);
const penggunaanLayer = L.geoJSON(penggunaanGeoJSON, { style: stylePenggunaan, onEachFeature: onEachFeature }).addTo(map);
const dummyLayer = L.geoJSON(dummyGeoJSON, { pointToLayer: (f,latlng)=> L.circleMarker(latlng,{ radius:6, fillColor:'#f97316', color:'#fff', weight:1, fillOpacity:0.95 }), style: (f)=>({ color:'#f97316', weight:1, fillOpacity:0.12 }), onEachFeature: onEachFeature }).addTo(map);

// layers control
const overlayMaps = { 'Pola Ruang': zonasiLayer, 'Penggunaan Lahan': penggunaanLayer, 'Dummy Data': dummyLayer };
const layersControl = L.control.layers(baseMaps, overlayMaps, { position:'topright' }).addTo(map);

// ----- SYNCHRONIZE CHECKBOXES WITH LAYERS -----
function syncCheckboxWithLayer(checkboxId, layer) {
  const cb = document.getElementById(checkboxId);
  // set initial state based on layer presence
  cb.checked = map.hasLayer(layer);
  cb.addEventListener('change', ()=>{ if(cb.checked) map.addLayer(layer); else map.removeLayer(layer); });
  // also listen map events to reflect changes (in case user uses control layer)
  map.on('overlayadd overlayremove', ()=>{ cb.checked = map.hasLayer(layer); });
}
syncCheckboxWithLayer('toggleZonasi', zonasiLayer);
syncCheckboxWithLayer('toggleUse', penggunaanLayer);
syncCheckboxWithLayer('toggleDummy', dummyLayer);

// ----- TRANSIENT LAYER for search/location markers -----
const transientLayer = L.layerGroup().addTo(map);
function clearTransient(){ transientLayer.clearLayers(); }

// ----- SIDEBAR FEATURE LIST -----
const placeList = document.getElementById('placeList');
function addPlaceItem(feature, layer){
  const props = feature.properties || {};
  const el = document.createElement('div'); el.className='place';
  el.innerHTML = `<div class="icon w-10 h-10 rounded-full bg-white text-black flex items-center justify-center font-semibold">${(props.name||'X').slice(0,2).toUpperCase()}</div>
                  <div class="meta flex-1"><div class="name font-medium">${props.name||props.Nama||'Unnamed'}</div><div class="small">${props.use||props.tipe||props.kode||''}</div></div>
                  <div class="small">‚ñ∂</div>`;
  el.addEventListener('click', ()=>{ try{ if(layer.getBounds) map.fitBounds(layer.getBounds(),{ padding:[40,40] }); else if(layer.getLatLng) map.setView(layer.getLatLng(),16); showFeatureCard(props); layer.fire && layer.fire('click'); }catch(e){ console.warn(e); } });
  placeList.appendChild(el);
}
// populate list
[zonasiLayer, penggunaanLayer, dummyLayer].forEach(l=>{ l.eachLayer(function(layer){ if(layer.feature) addPlaceItem(layer.feature, layer); }); });

// ----- POPUP & FEATURE CARD -----
const card = document.getElementById('featureCard');
function onEachFeature(feature, layer){
  layer.on({ click: function(e){ const p = feature.properties || {}; const html = `<strong>${p.name||'Feature'}</strong><br>${p.description||p.use||p.keterangan||''}`; layer.bindPopup(html,{ maxWidth:320 }).openPopup(); showFeatureCard(p); } });
}

const fTitle = document.getElementById('fTitle');
const fDesc = document.getElementById('fDesc');
function showFeatureCard(props){ fTitle.textContent = props.name || props.Nama || 'Feature'; fDesc.textContent = props.description || props.keterangan || JSON.stringify(props).slice(0,200); card.classList.remove('hidden'); }
document.getElementById('closeCard').addEventListener('click', ()=> card.classList.add('hidden'));

// ----- SEARCH (coordinate) -----
document.getElementById('searchBtn').addEventListener('click', ()=>{
  const val = document.getElementById('coordInput').value.trim(); if(!val) return alert('Masukkan koordinat (contoh: -6.200, 106.816)');
  const parts = val.split(/[,;\s]+/).map(s=>parseFloat(s)).filter(x=>!isNaN(x)); let latlng=null; if(parts.length===2){ if(Math.abs(parts[0])<=90 && Math.abs(parts[1])<=180) latlng=[parts[0],parts[1]]; else if(Math.abs(parts[1])<=90 && Math.abs(parts[0])<=180) latlng=[parts[1],parts[0]]; }
  if(!latlng) return alert('Format koordinat tidak dikenali');
  clearTransient(); map.setView(latlng,16); L.marker(latlng).addTo(transientLayer).bindPopup('Hasil pencarian').openPopup();
});

// ----- GEOLOCATION -----
document.getElementById('locBtn').addEventListener('click', ()=>{
  if(!navigator.geolocation) return alert('Geolocation tidak didukung oleh browser Anda.');
  navigator.geolocation.getCurrentPosition((pos)=>{ clearTransient(); const lat = pos.coords.latitude, lng = pos.coords.longitude; map.setView([lat,lng],16); L.circleMarker([lat,lng],{ radius:8, fillColor:'#3b82f6', color:'#fff', weight:2, fillOpacity:0.95 }).addTo(transientLayer).bindPopup('Lokasi Saya').openPopup(); }, (err)=>{ alert('Gagal mendapatkan lokasi: '+err.message+'\nCatatan: fitur Lokasi Saya berfungsi di HTTPS atau http://localhost.'); }, { enableHighAccuracy:true, timeout:10000 });
});

// ----- BASEMAP CHANGE UI -----
map.on('baselayerchange', (e)=>{ document.getElementById('baseSelect').textContent = e.name || 'Basemap'; });

// ----- RESPONSIVE: hide card when zoomed out -----
map.on('zoomend', ()=>{ if(map.getZoom()<11) card.classList.add('hidden'); });

// ----- DEV NOTES -----
console.info('PINTAR Improved loaded. Replace zonasiGeoJSON & penggunaanGeoJSON with your QGIS-exported GeoJSON (EPSG:4326). To enable Google Satellite set USE_GOOGLE_SAT=true (ensure licensing).');
</script>
</body>
</html>
